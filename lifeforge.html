<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeForge - Developmental Biology Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #0a0e27 0%, #1a1a2e 100%);
            color: #e0f0ff;

            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
        }
        
        @media (min-width: 768px) {
            .container {
                padding: 20px;
            }
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #7fdbca;
        }
        
        @media (min-width: 768px) {
            header {
                padding: 30px 0;
                margin-bottom: 30px;
            }
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        @media (min-width: 768px) {
            h1 {
                font-size: 3rem;
            }
        }
        
        .tagline {
            font-size: 1rem;
            color: #a0c8ff;
            font-style: italic;
            margin-bottom: 8px;
        }
        
        @media (min-width: 768px) {
            .tagline {
                font-size: 1.2rem;
                margin-bottom: 10px;
            }
        }
        
        .subtitle {
            font-size: 0.9rem;
            color: #7fdbca;
        }
        
        @media (min-width: 768px) {
            .subtitle {
                font-size: 1rem;
            }
        }
        
        .main-layout {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 1024px) {
            .main-layout {
                display: grid;
                grid-template-columns: 300px 1fr;
                gap: 20px;
                margin-bottom: 30px;
            }
        }
        
        .control-panel {
            background: rgba(16, 32, 54, 0.7);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(79, 172, 254, 0.2);
            
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            height: fit-content;
        }
        
        @media (min-width: 768px) {
            .control-panel {
                padding: 20px;
            }
        }
        
        .panel-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #4facfe;
            border-bottom: 1px solid rgba(79, 172, 254, 0.3);
            padding-bottom: 8px;
        }
        
        @media (min-width: 768px) {
            .panel-title {
                font-size: 1.3rem;
                margin-bottom: 20px;
                padding-bottom: 10px;
            }
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        @media (min-width: 768px) {
            .control-group {
                margin-bottom: 20px;
            }
        }
        
        .control-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #a0c8ff;
            font-size: 0.85rem;
        }
        
        @media (min-width: 768px) {
            .control-label {
                font-size: 0.9rem;
            }
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 5px;
            background: rgba(79, 172, 254, 0.2);
            outline: none;
            touch-action: none;
        }
        
        @media (min-width: 768px) {
            .slider {
                height: 6px;
            }
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #4facfe;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(79, 172, 254, 0.7);
        }
        
        @media (min-width: 768px) {
            .slider::-webkit-slider-thumb {
                width: 18px;
                height: 18px;
            }
        }
        
        .slider-value {
            min-width: 45px;
            text-align: center;
            font-weight: bold;
            color: #4facfe;
            font-size: 0.9rem;
        }
        
        button {
            width: 100%;
            padding: 14px 12px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            color: #0a0e27;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            font-size: 0.9rem;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }
        
        @media (min-width: 768px) {
            button {
                padding: 12px;
                font-size: 0.95rem;
            }
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }
        
        @media (hover: none) {
            button:hover {
                transform: none;
            }
        }
        
        button.secondary {
            background: rgba(79, 172, 254, 0.2);
            color: #4facfe;
        }
        
        button.danger {
            background: linear-gradient(90deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
        }
        
        .viz-container {
            background: rgba(16, 32, 54, 0.7);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(79, 172, 254, 0.2);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }
        
        @media (min-width: 768px) {
            .viz-container {
                padding: 20px;
            }
        }
        
        .canvas-wrapper {
            position: relative;
            background: #0a0e1a;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
            touch-action: none;
        }
        
        canvas {
            display: block;
            width: 100%;
            height: 400px;
            touch-action: none;
        }
        
        @media (min-width: 768px) {
            canvas {
                height: 600px;
            }
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        @media (min-width: 640px) {
            .stats-bar {
                grid-template-columns: repeat(5, 1fr);
                gap: 15px;
                margin-top: 20px;
            }
        }
        
        .stat-card {
            background: rgba(10, 22, 40, 0.8);
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #4facfe;
            text-align: center;
        }
        
        @media (min-width: 768px) {
            .stat-card {
                padding: 15px;
            }
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 5px;
        }
        
        @media (min-width: 768px) {
            .stat-value {
                font-size: 1.8rem;
            }
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #a0c8ff;
        }
        
        @media (min-width: 768px) {
            .stat-label {
                font-size: 0.85rem;
            }
        }
        
        .cell-legend {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        
        @media (min-width: 640px) {
            .cell-legend {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                margin-top: 20px;
            }
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(10, 22, 40, 0.5);
            border-radius: 6px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            box-shadow: 0 0 8px currentColor;
            flex-shrink: 0;
        }
        
        @media (min-width: 768px) {
            .legend-color {
                width: 20px;
                height: 20px;
                box-shadow: 0 0 10px currentColor;
            }
        }
        
        .legend-label {
            font-size: 0.75rem;
            color: #cbd5e1;
        }
        
        @media (min-width: 768px) {
            .legend-label {
                font-size: 0.85rem;
            }
        }
        
        .phase-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(16, 32, 54, 0.95);
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #4facfe;
            font-size: 0.9rem;
            font-weight: bold;
            color: #4facfe;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        }
        
        @media (min-width: 768px) {
            .phase-indicator {
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                font-size: 1.1rem;
            }
        }
        
        .view-mode-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }
        
        @media (min-width: 768px) {
            .view-mode-selector {
                gap: 8px;
                margin-bottom: 15px;
            }
        }
        
        .view-btn {
            padding: 10px 8px;
            margin: 0;
            font-size: 0.8rem;
        }
        
        @media (min-width: 768px) {
            .view-btn {
                padding: 8px;
                font-size: 0.85rem;
            }
        }
        
        .view-btn.active {
            background: linear-gradient(90deg, #00f2fe 0%, #4facfe 100%);
            color: #0a0e27;
        }
        
        footer {
            text-align: center;
            padding: 15px;
            color: #64748b;
            border-top: 1px solid rgba(79, 172, 254, 0.2);
            margin-top: 20px;
            font-size: 0.8rem;
        }
        
        @media (min-width: 768px) {
            footer {
                padding: 20px;
                margin-top: 30px;
                font-size: 0.85rem;
            }
        }
        
        .info-panel {
            background: rgba(16, 32, 54, 0.7);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(79, 172, 254, 0.2);
        }
        
        @media (min-width: 768px) {
            .info-panel {
                padding: 20px;
                margin-bottom: 20px;
            }
        }
        
        .info-text {
            color: #a0c8ff;
            line-height: 1.6;
            font-size: 0.85rem;
        }
        
        @media (min-width: 768px) {
            .info-text {
                font-size: 0.95rem;
            }
        }
        
        /* Improve touch targets on mobile */
        @media (hover: none) and (pointer: coarse) {
            button {
                min-height: 44px;
            }
            
            .slider::-webkit-slider-thumb {
                width: 28px;
                height: 28px;
            }
            
            .view-btn {
                min-height: 44px;
            }
        }
        
        /* Hide scrollbars but keep functionality */
        .canvas-wrapper::-webkit-scrollbar {
            display: none;
        }
        
        .canvas-wrapper {
            -ms-overflow-style: none;
        }
    </style>
    <style>
        @media (min-width: 640px) { .stats-bar { grid-template-columns: repeat(5, 1fr); } }
    </style>
</head>
<body>
    <div class="phase-indicator" id="phaseIndicator">
        Development: READY
    </div>
    
    <div class="container">
        <header>
            <h1>🧬 LifeForge</h1>
            <div class="tagline">Watch life emerge from a single cell</div>
            <div class="subtitle">From DNA to organism through developmental biology</div>
        </header>
        
        <div class="info-panel">
            <div class="info-text">
                <strong>LifeForge simulates how a single cell becomes a complex organism.</strong> 
                Watch cells divide, differentiate into specialized types, and self-organize into patterns through chemical signals. 
                This is developmental biology in real-time - showing how genetic code becomes living form.
            </div>
        </div>
        
        <div class="main-layout">
            <div class="control-panel">
                <h2 class="panel-title">Development Controls</h2>
                
                <div class="control-group">
                    <button id="startBtn" class="primary">🧬 Start Development</button>
                    <button id="pauseBtn" class="secondary">⏸ Pause</button>
                    <button id="resetBtn" class="secondary">🔄 Reset to Single Cell</button>
                </div>
                
                <div class="control-group">
                    <label class="control-label">Development Speed</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="speedSlider" min="1" max="10" value="3" step="1" title="Development Speed">
                        <span class="slider-value" id="speedValue">3x</span>
                    </div>
                </div>
                
                <div class="control-group">
                    <label class="control-label">Mutation Rate</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="mutationSlider" min="0" max="20" value="2" step="1" title="Mutation Rate">
                        <span class="slider-value" id="mutationValue">2%</span>
                    </div>
                </div>
                
                <div class="control-group">
                    <label class="control-label">Morphogen Strength</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="morphogenSlider" min="1" max="10" value="5" step="1" title="Morphogen Strength">
                        <span class="slider-value" id="morphogenValue">5</span>
                    </div>
                </div>
                
                <div class="control-group">
                    <label class="control-label">Cell Division Rate</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="divisionSlider" min="1" max="10" value="5" step="1" title="Cell Division Rate">
                        <span class="slider-value" id="divisionValue">5</span>
                    </div>
                </div>
                
                <h2 class="panel-title" style="margin-top: 30px;">Experiments</h2>
                
                <button id="symmetricBtn">🦋 Bilateral Symmetry</button>
                <button id="segmentedBtn">🐛 Segmented Body</button>
                <button id="radialBtn">⭐ Radial Pattern</button>
                <button id="randomBtn">🎲 Random Development</button>
                
                <h2 class="panel-title" style="margin-top: 30px;">Interventions</h2>
                
                <button id="mutateBtn" class="danger">⚡ Cause Mutation</button>
                <button id="addCellsBtn">➕ Add Stem Cells</button>
                <button id="killCellsBtn" class="danger">💥 Kill Random Cells</button>
                
                <h2 class="panel-title" style="margin-top: 30px;">Export</h2>
                
                <button id="exportImageBtn">📸 Export as Image</button>
                <button id="exportDataBtn">💾 Export Cell Data</button>
                <button id="exportStatsBtn">📊 Export Statistics</button>
            </div>
            
            <div class="viz-container">
                <div class="view-mode-selector">
                    <button class="view-btn active" data-view="cells">Cell Types</button>
                    <button class="view-btn" data-view="chemicals">Chemicals</button>
                    <button class="view-btn" data-view="genes">Gene Activity</button>
                </div>
                
                <div class="canvas-wrapper">
                    <canvas id="lifeCanvas"></canvas>
                <div class="stats-bar">
                    <div class="stat-card">
                        <div class="stat-value" id="cellCount">1</div>
                        <div class="stat-label">Total Cells</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stemCells">1</div>
                        <div class="stat-label">Stem Cells</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="divisions">0</div>
                        <div class="stat-label">Cell Divisions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="generation">0</div>
                        <div class="stat-label">Generation</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="timeElapsed">0s</div>
                        <div class="stat-label">Time Elapsed</div>
                    </div>
                </div>
                
                <div class="cell-legend">
                </div>
                
                <div class="cell-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #a855f7; color: #a855f7;"></div>
                        <span class="legend-label">Stem (Undifferentiated)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ef4444; color: #ef4444;"></div>
                        <span class="legend-label">Muscle (Movement)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #3b82f6; color: #3b82f6;"></div>
                        <span class="legend-label">Neural (Sensing)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #10b981; color: #10b981;"></div>
                        <span class="legend-label">Digestive (Energy)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f59e0b; color: #f59e0b;"></div>
                        <span class="legend-label">Structural (Support)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ec4899; color: #ec4899;"></div>
                        <span class="legend-label">Reproductive (Offspring)</span>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            LifeForge - Where information becomes form
            <br>Simulating the bridge between genotype and phenotype
        </footer>
    </div>

    <script>
        // ============================================
        // LIFEFORGE - DEVELOPMENTAL BIOLOGY SIMULATOR
        // ============================================
        
        const canvas = document.getElementById('lifeCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        const phaseIndicator = document.getElementById('phaseIndicator');
        
        // Configuration - define FIRST before anything else
        const Config = {
            cellSize: window.innerWidth < 640 ? 6 : 8,
            gridWidth: 0,
            gridHeight: 0,
            maxCells: 2500,
            updatesPerFrame: 3,
            speed: 3,
            mutationRate: 0.02,
            morphogenStrength: 5,
            divisionRate: 5,
            developmentMode: 'symmetric'
        };
        
        // DOM Elements
        const cellCountEl = document.getElementById('cellCount');
        const stemCellsEl = document.getElementById('stemCells');
        const divisionsEl = document.getElementById('divisions');
        const generationEl = document.getElementById('generation');
        const speedValueEl = document.getElementById('speedValue');
        const mutationValueEl = document.getElementById('mutationValue');

        // Set canvas size - define the function but DON'T call it yet
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            // Mobile-friendly height
            if (window.innerWidth < 768) {
                canvas.height = 400;
            } else {
                canvas.height = 600;
            }
            
            // Recalculate grid dimensions
            Config.gridWidth = Math.floor(canvas.width / Config.cellSize);
            Config.gridHeight = Math.floor(canvas.height / Config.cellSize);
            
            // Reinitialize morphogen field with new dimensions
            if (typeof morphogenField !== 'undefined') {
                morphogenField = new MorphogenField();
            }
            
            // Redraw if we have cells
            if (typeof cells !== 'undefined' && cells.length > 0) {
                draw();
            }
        }
        
        // Cell types with colors
        const CellTypes = {
            STEM: { name: 'stem', color: '#a855f7', glow: 'rgba(168, 85, 247, 0.5)', produces: null },
            MUSCLE: { name: 'muscle', color: '#ef4444', glow: 'rgba(239, 68, 68, 0.5)', produces: 'ap' },
            NEURAL: { name: 'neural', color: '#3b82f6', glow: 'rgba(59, 130, 246, 0.5)', produces: 'dv' },
            DIGESTIVE: { name: 'digestive', color: '#10b981', glow: 'rgba(16, 185, 129, 0.5)', produces: null },
            STRUCTURAL: { name: 'structural', color: '#f59e0b', glow: 'rgba(245, 158, 11, 0.5)', produces: null },
            REPRODUCTIVE: { name: 'reproductive', color: '#ec4899', glow: 'rgba(236, 72, 153, 0.5)', produces: 'lr' },
            DEAD: { name: 'dead', color: '#475569', glow: 'rgba(71, 85, 105, 0.5)', produces: null }
        };
        
        // Cell class
        class Cell {
            constructor(x, y, type = CellTypes.STEM, generation = 0) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.age = 0;
                this.generation = generation;
                this.energy = 150;
                this.divisionCooldown = 10;
                this.readyToDivide = false;
                this.isProgenitor = false;
            }
            
            update(morphogenField, cellGrid) {
                this.age++;
                this.divisionCooldown = Math.max(0, this.divisionCooldown - 1);
                this.energy -= 2; // Increased cost of living
                
                // Energy production and sharing
                if (this.type === CellTypes.DIGESTIVE) {
                    this.energy = Math.min(250, this.energy + 5); // Produce energy
                } else {
                    // Request energy from neighbors
                    const directions = [{dx: 1, dy: 0}, {dx: -1, dy: 0}, {dx: 0, dy: 1}, {dx: 0, dy: -1}];
                    for (const dir of directions) {
                        const nx = this.x + dir.dx;
                        const ny = this.y + dir.dy;

                        if (nx >= 0 && nx < Config.gridWidth && ny >= 0 && ny < Config.gridHeight) {
                            const neighborIndex = ny * Config.gridWidth + nx;
                            const neighbor = cellGrid[neighborIndex];

                            if (neighbor && neighbor.type === CellTypes.DIGESTIVE && neighbor.energy > 100) {
                                const transferAmount = 10;
                                this.energy = Math.min(150, this.energy + transferAmount);
                                neighbor.energy -= transferAmount; // Energy is transferred, not created
                                break; // Only need to get energy from one neighbor
                            }
                        }
                    }
                }


                // --- Differentiation and Division ---
                const signals = morphogenField.getSignalsAt(this.x, this.y);
                
                // Differentiation logic based on position and signals
                if (this.isProgenitor && this.type === CellTypes.STEM && this.age > 20 && this.energy > 50) {
                    this.differentiate(signals);
                    this.isProgenitor = false; // It has now differentiated
                }
                
                // Division readiness
                if (this.type === CellTypes.STEM && this.divisionCooldown === 0 && this.energy > 100 && Math.random() < Config.divisionRate / 50) {
                    this.readyToDivide = true;
                    this.energy -= 50; // Cost of preparing to divide
                }

                // Apoptosis (programmed cell death)
                if (this.energy <= 0) {
                    this.type = CellTypes.DEAD;
                }
            }
            
            differentiate(signals) {
                // Differentiation based on local chemical signals
                const { ap, dv, lr } = signals;

                // Find the strongest signal
                if (ap > dv && ap > lr && ap > 0.3) {
                    this.type = CellTypes.MUSCLE;
                } else if (dv > ap && dv > lr && dv > 0.3) {
                    this.type = CellTypes.NEURAL;
                } else if (lr > ap && lr > dv && lr > 0.3) {
                    this.type = CellTypes.REPRODUCTIVE;
                } else if (ap < 0.2 && dv < 0.2 && lr < 0.2) {
                    // Low signal areas become digestive
                    this.type = CellTypes.DIGESTIVE;
                } else {
                    // Default to structural if signals are mixed or weak
                    this.type = CellTypes.STRUCTURAL;
                }
                
                // Mutation chance
                if (Math.random() < Config.mutationRate) {
                    const types = [CellTypes.MUSCLE, CellTypes.NEURAL, CellTypes.DIGESTIVE, CellTypes.STRUCTURAL, CellTypes.REPRODUCTIVE];
                    this.type = types[Math.floor(Math.random() * types.length)];
                }
            }
        }
        
        // Morphogen field for chemical signaling
        class MorphogenField {
            constructor() {
                this.ap = []; // Anterior-Posterior
                this.dv = []; // Dorsal-Ventral
                this.lr = []; // Left-Right
                this.initialize();
            }
            
            initialize() {
                const size = Config.gridWidth * Config.gridHeight;
                this.ap = new Array(size).fill(0);
                this.dv = new Array(size).fill(0);
                this.lr = new Array(size).fill(0);

                // Initial morphogen sources based on mode
                if (Config.developmentMode === 'symmetric') {
                    this.ap[Math.floor(Config.gridHeight / 2) * Config.gridWidth + Math.floor(Config.gridWidth * 0.2)] = 1;
                    this.dv[Math.floor(Config.gridHeight * 0.2) * Config.gridWidth + Math.floor(Config.gridWidth / 2)] = 1;
                } else if (Config.developmentMode === 'segmented') {
                    for(let i = 1; i < 5; i++) {
                        this.ap[Math.floor(Config.gridHeight * i / 5) * Config.gridWidth + Math.floor(Config.gridWidth / 2)] = 1;
                    }
                } else if (Config.developmentMode === 'radial') {
                     this.ap[Math.floor(Config.gridHeight / 2) * Config.gridWidth + Math.floor(Config.gridWidth / 2)] = 1;
                }
            }

            update(cells) {
                // Diffusion and decay
                this.diffuse(this.ap, 0.05, 0.001);
                this.diffuse(this.dv, 0.05, 0.001);
                this.diffuse(this.lr, 0.05, 0.001);

                // Cells producing morphogens
                cells.forEach(cell => {
                    if (cell.type.produces) {
                        const index = cell.y * Config.gridWidth + cell.x;
                        this[cell.type.produces][index] = Math.min(1, this[cell.type.produces][index] + 0.2 * (Config.morphogenStrength / 5));
                    }
                });
            }

            diffuse(grid, diffusionRate, decayRate) {
                const newGrid = [...grid];
                const { gridWidth, gridHeight } = Config;

                for (let y = 0; y < Config.gridHeight; y++) {
                    for (let x = 0; x < Config.gridWidth; x++) {
                        const index = y * gridWidth + x;
                        let sum = 0;
                        let count = 0;

                        // Kernel for diffusion
                        for (let dy = -1; dy <= 1; dy++) {
                            for (let dx = -1; dx <= 1; dx++) {
                                const nx = x + dx;
                                const ny = y + dy;
                                if (nx >= 0 && nx < gridWidth && ny >= 0 && ny < gridHeight) {
                                    sum += grid[ny * gridWidth + nx];
                                    count++;
                                }
                            }
                        }
                        
                        const average = sum / count;
                        newGrid[index] += (average - grid[index]) * diffusionRate;
                        newGrid[index] *= (1 - decayRate); // Decay
                    }
                }
                // Copy back
                for(let i = 0; i < grid.length; i++) grid[i] = newGrid[i];
            }
            
            getSignalsAt(x, y) {
                const index = y * Config.gridWidth + x;
                return {
                    ap: this.ap[index] || 0,
                    dv: this.dv[index] || 0,
                    lr: this.lr[index] || 0
                };
            }
        }
        
        // Main simulation state
        let cells = [];
        let morphogenField = new MorphogenField();
        let running = false;
        let time = 0;
        let totalDivisions = 0;
        let lastFrameTime = 0;
        let viewMode = 'cells';
        let startTime = 0;
        
        // Initialize with single cell
        function initialize() {
            cells = [new Cell(
                Math.floor(Config.gridWidth / 2),
                Math.floor(Config.gridHeight / 2),
                CellTypes.STEM,
                0
            )];
            totalDivisions = 0;
            time = 0;
            morphogenField.initialize();
            startTime = 0;
            updateStats();
            updatePhase();
        }
        
        // Update simulation
        function gameLoop(timestamp) {
            if (!running) return;

            const elapsed = timestamp - lastFrameTime;
            const interval = 1000 / Config.speed;

            if (elapsed > interval) {
                lastFrameTime = timestamp - (elapsed % interval);
                
                for (let i = 0; i < Config.updatesPerFrame; i++) {
                    update();
                }
                draw();
            }

            requestAnimationFrame(gameLoop);
        }

        function update() {
            time++;

            // Create a spatial grid for efficient neighbor lookups
            const cellGrid = new Array(Config.gridWidth * Config.gridHeight).fill(null);
            cells.forEach(cell => {
                const index = cell.y * Config.gridWidth + cell.x;
                cellGrid[index] = cell;
            });
            
            // Cell division
            const newCells = [];
            cells.forEach(cell => {
                if (cell.readyToDivide && cells.length < Config.maxCells) {
                    // Find empty neighbor
                    const directions = [
                        {dx: 1, dy: 0}, {dx: -1, dy: 0},
                        {dx: 0, dy: 1}, {dx: 0, dy: -1}
                    ];
                    
                    for (const dir of directions) {
                        const nx = cell.x + dir.dx;
                        const ny = cell.y + dir.dy;
                        
                        if (nx >= 0 && nx < Config.gridWidth && ny >= 0 && ny < Config.gridHeight) {
                            const occupied = cells.some(c => c.x === nx && c.y === ny) || newCells.some(c => c.x === nx && c.y === ny);
                            if (!occupied) {
                                const newCell = new Cell(nx, ny, CellTypes.STEM, cell.generation + 1);
                                newCell.isProgenitor = true; // This new cell is primed to differentiate
                                newCells.push(newCell);
                                cell.divisionCooldown = 20 + Math.floor(Math.random() * 20);
                                cell.readyToDivide = false;
                                totalDivisions++;
                                break;
                            }
                        }
                    }
                }
            });
            
            if (newCells.length > 0) {
                cells.push(...newCells);
            }

            // Update all cells and remove dead ones
            cells.forEach(cell => cell.update(morphogenField, cellGrid));
            cells = cells.filter(cell => cell.type !== CellTypes.DEAD);

            // Check for organism death
            if (cells.length === 0 && totalDivisions > 0) {
                running = false;
                updatePhase(); // Final phase update
                return; // Stop further updates
            }
            // Update morphogen field
            morphogenField.update(cells);
            
            // Update stats and phase (less frequently)
            updateStats();
            updatePhase();
        }
        
        // Draw cells
        function draw() {
            // Clear canvas
            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (viewMode === 'cells') {
                drawCells();
            } else if (viewMode === 'chemicals') {
                drawChemicals();
            } else if (viewMode === 'genes') {
                drawGeneActivity();
            }
        }
        
        function drawCells() {
            cells.forEach(cell => {
                const x = cell.x * Config.cellSize;
                const y = cell.y * Config.cellSize;
                
                // Cell body
                ctx.fillStyle = cell.type.color;
                ctx.beginPath();
                ctx.arc(x + Config.cellSize/2, y + Config.cellSize/2, Config.cellSize/2 - 1, 0, Math.PI * 2);
                ctx.fill();
                
                // Glow effect
                if (cell.age < 10) {
                    ctx.shadowColor = cell.type.glow;
                    ctx.shadowBlur = 10;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
            });
        }
        
        function drawChemicals() {
            // Draw morphogen gradient
            for (let y = 0; y < Config.gridHeight; y++) {
                for (let x = 0; x < Config.gridWidth; x++) {
                    const signals = morphogenField.getSignalsAt(x, y);
                    const r = Math.floor(signals.ap * 255);
                    const g = Math.floor(signals.dv * 255);
                    const b = Math.floor(signals.lr * 255);
                    const alpha = Math.max(r,g,b) / 255 * 0.6;
                    
                    ctx.fillStyle = `rgba(${r}, ${g}, ${b}, ${alpha})`;
                    ctx.fillRect(x * Config.cellSize, y * Config.cellSize, Config.cellSize, Config.cellSize);
                }
            }
            
            // Draw cells on top
            cells.forEach(cell => {
                const x = cell.x * Config.cellSize;
                const y = cell.y * Config.cellSize;
                
                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.beginPath();
                ctx.arc(x + Config.cellSize/2, y + Config.cellSize/2, Config.cellSize/3, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        function drawGeneActivity() {
            cells.forEach(cell => {
                const x = cell.x * Config.cellSize;
                const y = cell.y * Config.cellSize;
                
                // Color by gene expression (age-based as proxy)
                const activity = Math.min(cell.age / 50, 1);
                const r = Math.floor(activity * 255);
                const g = Math.floor((1 - activity) * 255);
                
                ctx.fillStyle = `rgb(${r}, ${g}, 100)`;
                ctx.fillRect(x, y, Config.cellSize, Config.cellSize);
                
                // Highlight dividing cells
                if (cell.readyToDivide) {
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, Config.cellSize, Config.cellSize);
                }
            });
        }
        
        // Update statistics
        function updateStats() {
            const stemCount = cells.filter(c => c.type === CellTypes.STEM).length;
            const maxGen = cells.length > 0 ? Math.max(...cells.map(c => c.generation)) : 0;
            
            cellCountEl.textContent = cells.length;
            stemCellsEl.textContent = stemCount;
            divisionsEl.textContent = totalDivisions;
            generationEl.textContent = maxGen;

            // Update time elapsed
            if (running && startTime > 0) {
                const elapsedSeconds = Math.floor((performance.now() - startTime) / 1000);
                document.getElementById('timeElapsed').textContent = `${elapsedSeconds}s`;
            } else if (startTime === 0) {
                document.getElementById('timeElapsed').textContent = '0s';
            }
        }
        
        // Update phase indicator
        function updatePhase() {
            let phase = '';
            if (cells.length === 0 && totalDivisions > 0) {
                phase = 'DECEASED';
            } else if (cells.length === 1) {
                phase = 'SINGLE CELL';
            } else if (cells.length < 10) {
                phase = 'EARLY DIVISION';
            } else if (cells.length < 50) {
                phase = 'DIFFERENTIATION';
            } else if (cells.length < 200) {
                phase = 'MORPHOGENESIS';
            } else if (cells.length < Config.maxCells * 0.9) {
                phase = 'MATURING';
            } else {
                phase = 'MATURE ORGANISM';
            }
            
            phaseIndicator.textContent = `Development: ${phase}`;
        }
        
        // Control event listeners
        document.getElementById('startBtn').addEventListener('click', () => {
            if (!running) {
                running = true;
                if (startTime === 0) {
                    startTime = performance.now();
                }
                lastFrameTime = performance.now();
                requestAnimationFrame(gameLoop);
            }
        });
        
        document.getElementById('pauseBtn').addEventListener('click', () => {
            running = false;
        });
        
        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            initialize();
            draw();
        });
        
        document.getElementById('speedSlider').addEventListener('input', function() {
            Config.speed = parseInt(this.value);
            speedValueEl.textContent = this.value + 'x';
        });
        
        document.getElementById('mutationSlider').addEventListener('input', function() {
            Config.mutationRate = parseInt(this.value) / 100;
            mutationValueEl.textContent = this.value + '%';
        });
        
        document.getElementById('morphogenSlider').addEventListener('input', function() {
            Config.morphogenStrength = parseInt(this.value);
            document.getElementById('morphogenValue').textContent = this.value; // No dedicated element, fine for now
        });
        
        document.getElementById('divisionSlider').addEventListener('input', function() {
            Config.divisionRate = parseInt(this.value);
            document.getElementById('divisionValue').textContent = this.value;
        });
        
        // Experiment buttons
        document.getElementById('symmetricBtn').addEventListener('click', () => {
            Config.developmentMode = 'symmetric';
            initialize();
            draw();
        });
        
        document.getElementById('segmentedBtn').addEventListener('click', () => {
            Config.developmentMode = 'segmented';
            initialize();
            draw();
        });
        
        document.getElementById('radialBtn').addEventListener('click', () => {
            Config.developmentMode = 'radial';
            initialize();
            draw();
        });
        
        document.getElementById('randomBtn').addEventListener('click', () => {
            Config.developmentMode = 'random';
            initialize();
            draw();
        });
        
        // Intervention buttons
        document.getElementById('mutateBtn').addEventListener('click', () => {
            cells.forEach(cell => {
                if (Math.random() < 0.3) {
                    const types = [CellTypes.MUSCLE, CellTypes.NEURAL, CellTypes.DIGESTIVE, CellTypes.STRUCTURAL, CellTypes.REPRODUCTIVE];
                    cell.type = types[Math.floor(Math.random() * types.length)];
                }
            });
            draw();
        });
        
        document.getElementById('addCellsBtn').addEventListener('click', () => {
            for (let i = 0; i < 10; i++) {
                const x = Math.floor(Math.random() * Config.gridWidth);
                const y = Math.floor(Math.random() * Config.gridHeight);
                const occupied = cells.some(c => c.x === x && c.y === y);
                if (!occupied) {
                    cells.push(new Cell(x, y, CellTypes.STEM, 0));
                }
            }
            updateStats();
            draw();
        });
        
        document.getElementById('killCellsBtn').addEventListener('click', () => {
            const toRemove = Math.floor(cells.length * 0.2);
            for (let i = 0; i < toRemove; i++) {
                const index = Math.floor(Math.random() * cells.length);
                cells.splice(index, 1);
            }
            updateStats();
            draw();
        });
        
        // View mode buttons
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                viewMode = this.dataset.view;
                draw();
            });
        });
        
        // Export functions
        document.getElementById('exportImageBtn').addEventListener('click', () => {
            // Create a temporary canvas with white background
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = canvas.width;
            exportCanvas.height = canvas.height;
            const exportCtx = exportCanvas.getContext('2d');
            
            // Fill with dark background
            exportCtx.fillStyle = '#0a0e1a';
            exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
            
            // Draw current canvas content
            exportCtx.drawImage(canvas, 0, 0);
            
            // Add title and info
            exportCtx.fillStyle = '#4facfe';
            exportCtx.font = 'bold 20px Arial';
            exportCtx.fillText('LifeForge - Developmental Biology', 10, 30);
            
            exportCtx.fillStyle = '#a0c8ff';
            exportCtx.font = '14px Arial';
            exportCtx.fillText(`Cells: ${cells.length} | Phase: ${phaseIndicator.textContent}`, 10, 55);
            exportCtx.fillText(`Mode: ${Config.developmentMode} | Time: ${time} cycles`, 10, 75);
            
            // Convert to download
            exportCanvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lifeforge-${Date.now()}.png`;
                a.click();
                URL.revokeObjectURL(url);
            });
        });
        
        document.getElementById('exportDataBtn').addEventListener('click', () => {
            // Create comprehensive cell data export
            const exportData = {
                metadata: {
                    timestamp: new Date().toISOString(),
                    developmentTime: time + " cycles",
                    phase: phaseIndicator.textContent,
                    developmentMode: Config.developmentMode,
                    config: {
                        cellSize: Config.cellSize,
                        mutationRate: Config.mutationRate,
                        morphogenStrength: Config.morphogenStrength,
                        divisionRate: Config.divisionRate
                    }
                },
                statistics: {
                    totalCells: cells.length,
                    stemCells: cells.filter(c => c.type === CellTypes.STEM).length,
                    muscleCells: cells.filter(c => c.type === CellTypes.MUSCLE).length,
                    neuralCells: cells.filter(c => c.type === CellTypes.NEURAL).length,
                    digestiveCells: cells.filter(c => c.type === CellTypes.DIGESTIVE).length,
                    structuralCells: cells.filter(c => c.type === CellTypes.STRUCTURAL).length,
                    reproductiveCells: cells.filter(c => c.type === CellTypes.REPRODUCTIVE).length,
                    totalDivisions: totalDivisions,
                    maxGeneration: cells.length > 0 ? Math.max(...cells.map(c => c.generation)) : 0
                },
                cells: cells.map(cell => ({
                    x: cell.x,
                    y: cell.y,
                    type: cell.type.name,
                    age: cell.age,
                    generation: cell.generation,
                    energy: cell.energy
                }))
            };
            
            // Convert to JSON and download
            const jsonStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lifeforge-data-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });
        
        function safePercentage(count, total) {
            if (total === 0) {
                return '0.0';
            }
            return ((count / total) * 100).toFixed(1);
        }

        document.getElementById('exportStatsBtn').addEventListener('click', () => {
            // Create human-readable statistics report
            const stemCount = cells.filter(c => c.type === CellTypes.STEM).length;
            const muscleCount = cells.filter(c => c.type === CellTypes.MUSCLE).length;
            const neuralCount = cells.filter(c => c.type === CellTypes.NEURAL).length;
            const digestiveCount = cells.filter(c => c.type === CellTypes.DIGESTIVE).length;
            const structuralCount = cells.filter(c => c.type === CellTypes.STRUCTURAL).length;
            const reproductiveCount = cells.filter(c => c.type === CellTypes.REPRODUCTIVE).length;
            const maxGen = cells.length > 0 ? Math.max(...cells.map(c => c.generation)) : 0;
            const totalCellCount = cells.length;
            
            const report = `
╔════════════════════════════════════════════════════════════════╗
║              LIFEFORGE DEVELOPMENT REPORT                      ║
╚════════════════════════════════════════════════════════════════╝

Generated: ${new Date().toLocaleString()}
Development Mode: ${Config.developmentMode}
Development Phase: ${phaseIndicator.textContent}

═══════════════════════════════════════════════════════════════
ORGANISM STATISTICS
═══════════════════════════════════════════════════════════════

Total Cells:              ${totalCellCount}
Cell Divisions:           ${totalDivisions}
Maximum Generation:       ${maxGen}
Development Time:         ${time} cycles

═══════════════════════════════════════════════════════════════
CELL TYPE DISTRIBUTION
═══════════════════════════════════════════════════════════════

🟣 Stem Cells:            ${stemCount} (${safePercentage(stemCount, totalCellCount)}%)
🔴 Muscle Cells:          ${muscleCount} (${safePercentage(muscleCount, totalCellCount)}%)
🔵 Neural Cells:          ${neuralCount} (${safePercentage(neuralCount, totalCellCount)}%)
🟢 Digestive Cells:       ${digestiveCount} (${safePercentage(digestiveCount, totalCellCount)}%)
🟡 Structural Cells:      ${structuralCount} (${safePercentage(structuralCount, totalCellCount)}%)
🩷 Reproductive Cells:    ${reproductiveCount} (${safePercentage(reproductiveCount, totalCellCount)}%)

═══════════════════════════════════════════════════════════════
DEVELOPMENT PARAMETERS
═══════════════════════════════════════════════════════════════

Cell Size:                ${Config.cellSize}px
Mutation Rate:            ${(Config.mutationRate * 100).toFixed(1)}%
Morphogen Strength:       ${Config.morphogenStrength}
Division Rate:            ${Config.divisionRate}
Simulation Speed:         ${Config.speed}x

═══════════════════════════════════════════════════════════════
ANALYSIS
═══════════════════════════════════════════════════════════════

Differentiation Progress: ${safePercentage(totalCellCount - stemCount, totalCellCount)}%
Most Common Cell Type:    ${
    totalCellCount > 0 ? [
            {name: 'Stem', count: stemCount},
            {name: 'Muscle', count: muscleCount},
            {name: 'Neural', count: neuralCount},
            {name: 'Digestive', count: digestiveCount},
            {name: 'Structural', count: structuralCount},
            {name: 'Reproductive', count: reproductiveCount}
        ].sort((a, b) => b.count - a.count)[0].name : 'None'
}
Development Stage:        ${
    totalCellCount === 0 ? (totalDivisions > 0 ? 'Deceased' : 'Primordial') :
    totalCellCount === 1 ? 'Single Cell' :
    totalCellCount < 10 ? 'Early Division' :
    totalCellCount < 50 ? 'Differentiation' :
    totalCellCount < 200 ? 'Morphogenesis' :
    'Mature Organism'
}

═══════════════════════════════════════════════════════════════

Generated by LifeForge - Developmental Biology Simulator
Where information becomes form
═══════════════════════════════════════════════════════════════
`;
            
            // Download as text file
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lifeforge-report-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        });
        
        // Initialize on load - CALL EVERYTHING AT THE END
        window.addEventListener('load', () => {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            initialize();
            draw();
        });
    </script>
</body>
</html>