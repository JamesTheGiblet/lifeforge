<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeForge - Developmental Biology Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #0a0e27 0%, #1a1a2e 100%);
            color: #e0f0ff;
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: pan-y;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
        }
        
        @media (min-width: 768px) {
            .container {
                padding: 20px;
            }
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #7fdbca;
        }
        
        @media (min-width: 768px) {
            header {
                padding: 30px 0;
                margin-bottom: 30px;
            }
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        @media (min-width: 768px) {
            h1 {
                font-size: 3rem;
            }
        }
        
        .tagline {
            font-size: 1rem;
            color: #a0c8ff;
            font-style: italic;
            margin-bottom: 8px;
        }
        
        @media (min-width: 768px) {
            .tagline {
                font-size: 1.2rem;
                margin-bottom: 10px;
            }
        }
        
        .subtitle {
            font-size: 0.9rem;
            color: #7fdbca;
        }
        
        @media (min-width: 768px) {
            .subtitle {
                font-size: 1rem;
            }
        }
        
        .main-layout {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 1024px) {
            .main-layout {
                display: grid;
                grid-template-columns: 300px 1fr;
                gap: 20px;
                margin-bottom: 30px;
            }
        }
        
        .control-panel {
            background: rgba(16, 32, 54, 0.7);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(79, 172, 254, 0.2);
            backdrop-filter: blur(10px);
            height: fit-content;
        }
        
        @media (min-width: 768px) {
            .control-panel {
                padding: 20px;
            }
        }
        
        .panel-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #4facfe;
            border-bottom: 1px solid rgba(79, 172, 254, 0.3);
            padding-bottom: 8px;
        }
        
        @media (min-width: 768px) {
            .panel-title {
                font-size: 1.3rem;
                margin-bottom: 20px;
                padding-bottom: 10px;
            }
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        @media (min-width: 768px) {
            .control-group {
                margin-bottom: 20px;
            }
        }
        
        .control-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #a0c8ff;
            font-size: 0.85rem;
        }
        
        @media (min-width: 768px) {
            .control-label {
                font-size: 0.9rem;
            }
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .slider {
            flex: 1;
            -webkit-appearance: none;
            height: 8px;
            border-radius: 5px;
            background: rgba(79, 172, 254, 0.2);
            outline: none;
            touch-action: none;
        }
        
        @media (min-width: 768px) {
            .slider {
                height: 6px;
            }
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #4facfe;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(79, 172, 254, 0.7);
        }
        
        @media (min-width: 768px) {
            .slider::-webkit-slider-thumb {
                width: 18px;
                height: 18px;
            }
        }
        
        .slider-value {
            min-width: 45px;
            text-align: center;
            font-weight: bold;
            color: #4facfe;
            font-size: 0.9rem;
        }
        
        button {
            width: 100%;
            padding: 14px 12px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            color: #0a0e27;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            font-size: 0.9rem;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }
        
        @media (min-width: 768px) {
            button {
                padding: 12px;
                font-size: 0.95rem;
            }
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }
        
        @media (hover: none) {
            button:hover {
                transform: none;
            }
        }
        
        button.secondary {
            background: rgba(79, 172, 254, 0.2);
            color: #4facfe;
        }
        
        button.danger {
            background: linear-gradient(90deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
        }
        
        .viz-container {
            background: rgba(16, 32, 54, 0.7);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(79, 172, 254, 0.2);
            backdrop-filter: blur(10px);
        }
        
        @media (min-width: 768px) {
            .viz-container {
                padding: 20px;
            }
        }
        
        .canvas-wrapper {
            position: relative;
            background: #0a0e1a;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
            touch-action: none;
        }
        
        canvas {
            display: block;
            width: 100%;
            height: 400px;
            touch-action: none;
        }
        
        @media (min-width: 768px) {
            canvas {
                height: 600px;
            }
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        @media (min-width: 640px) {
            .stats-bar {
                grid-template-columns: repeat(4, 1fr);
                gap: 15px;
                margin-top: 20px;
            }
        }
        
        .stat-card {
            background: rgba(10, 22, 40, 0.8);
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #4facfe;
            text-align: center;
        }
        
        @media (min-width: 768px) {
            .stat-card {
                padding: 15px;
            }
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 5px;
        }
        
        @media (min-width: 768px) {
            .stat-value {
                font-size: 1.8rem;
            }
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #a0c8ff;
        }
        
        @media (min-width: 768px) {
            .stat-label {
                font-size: 0.85rem;
            }
        }
        
        .cell-legend {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        
        @media (min-width: 640px) {
            .cell-legend {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                margin-top: 20px;
            }
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(10, 22, 40, 0.5);
            border-radius: 6px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            box-shadow: 0 0 8px currentColor;
            flex-shrink: 0;
        }
        
        @media (min-width: 768px) {
            .legend-color {
                width: 20px;
                height: 20px;
                box-shadow: 0 0 10px currentColor;
            }
        }
        
        .legend-label {
            font-size: 0.75rem;
            color: #cbd5e1;
        }
        
        @media (min-width: 768px) {
            .legend-label {
                font-size: 0.85rem;
            }
        }
        
        .phase-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(16, 32, 54, 0.95);
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #4facfe;
            font-size: 0.9rem;
            font-weight: bold;
            color: #4facfe;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        }
        
        @media (min-width: 768px) {
            .phase-indicator {
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                font-size: 1.1rem;
            }
        }
        
        .view-mode-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }
        
        @media (min-width: 768px) {
            .view-mode-selector {
                gap: 8px;
                margin-bottom: 15px;
            }
        }
        
        .view-btn {
            padding: 10px 8px;
            margin: 0;
            font-size: 0.8rem;
        }
        
        @media (min-width: 768px) {
            .view-btn {
                padding: 8px;
                font-size: 0.85rem;
            }
        }
        
        .view-btn.active {
            background: linear-gradient(90deg, #00f2fe 0%, #4facfe 100%);
            color: #0a0e27;
        }
        
        footer {
            text-align: center;
            padding: 15px;
            color: #64748b;
            border-top: 1px solid rgba(79, 172, 254, 0.2);
            margin-top: 20px;
            font-size: 0.8rem;
        }
        
        @media (min-width: 768px) {
            footer {
                padding: 20px;
                margin-top: 30px;
                font-size: 0.85rem;
            }
        }
        
        .info-panel {
            background: rgba(16, 32, 54, 0.7);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(79, 172, 254, 0.2);
        }
        
        @media (min-width: 768px) {
            .info-panel {
                padding: 20px;
                margin-bottom: 20px;
            }
        }
        
        .info-text {
            color: #a0c8ff;
            line-height: 1.6;
            font-size: 0.85rem;
        }
        
        @media (min-width: 768px) {
            .info-text {
                font-size: 0.95rem;
            }
        }
        
        /* Improve touch targets on mobile */
        @media (hover: none) and (pointer: coarse) {
            button {
                min-height: 44px;
            }
            
            .slider::-webkit-slider-thumb {
                width: 28px;
                height: 28px;
            }
            
            .view-btn {
                min-height: 44px;
            }
        }
        
        /* Hide scrollbars but keep functionality */
        .canvas-wrapper::-webkit-scrollbar {
            display: none;
        }
        
        .canvas-wrapper {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <div class="phase-indicator" id="phaseIndicator">
        Development: READY
    </div>
    
    <div class="container">
        <header>
            <h1>🧬 LifeForge</h1>
            <div class="tagline">Watch life emerge from a single cell</div>
            <div class="subtitle">From DNA to organism through developmental biology</div>
        </header>
        
        <div class="info-panel">
            <div class="info-text">
                <strong>LifeForge simulates how a single cell becomes a complex organism.</strong> 
                Watch cells divide, differentiate into specialized types, and self-organize into patterns through chemical signals. 
                This is developmental biology in real-time - showing how genetic code becomes living form.
            </div>
        </div>
        
        <div class="main-layout">
            <div class="control-panel">
                <h2 class="panel-title">Development Controls</h2>
                
                <div class="control-group">
                    <button id="startBtn" class="primary">🧬 Start Development</button>
                    <button id="pauseBtn" class="secondary">⏸ Pause</button>
                    <button id="resetBtn" class="secondary">🔄 Reset to Single Cell</button>
                </div>
                
                <div class="control-group">
                    <label class="control-label">Development Speed</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="speedSlider" min="1" max="10" value="3" step="1">
                        <span class="slider-value" id="speedValue">3x</span>
                    </div>
                </div>
                
                <div class="control-group">
                    <label class="control-label">Mutation Rate</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="mutationSlider" min="0" max="20" value="2" step="1">
                        <span class="slider-value" id="mutationValue">2%</span>
                    </div>
                </div>
                
                <div class="control-group">
                    <label class="control-label">Morphogen Strength</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="morphogenSlider" min="1" max="10" value="5" step="1">
                        <span class="slider-value" id="morphogenValue">5</span>
                    </div>
                </div>
                
                <div class="control-group">
                    <label class="control-label">Cell Division Rate</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="divisionSlider" min="1" max="10" value="5" step="1">
                        <span class="slider-value" id="divisionValue">5</span>
                    </div>
                </div>
                
                <h2 class="panel-title" style="margin-top: 30px;">Experiments</h2>
                
                <button id="symmetricBtn">🦋 Bilateral Symmetry</button>
                <button id="segmentedBtn">🐛 Segmented Body</button>
                <button id="radialBtn">⭐ Radial Pattern</button>
                <button id="randomBtn">🎲 Random Development</button>
                
                <h2 class="panel-title" style="margin-top: 30px;">Interventions</h2>
                
                <button id="mutateBtn" class="danger">⚡ Cause Mutation</button>
                <button id="addCellsBtn">➕ Add Stem Cells</button>
                <button id="killCellsBtn" class="danger">💥 Kill Random Cells</button>
                
                <h2 class="panel-title" style="margin-top: 30px;">Export</h2>
                
                <button id="exportImageBtn">📸 Export as Image</button>
                <button id="exportDataBtn">💾 Export Cell Data</button>
                <button id="exportStatsBtn">📊 Export Statistics</button>
            </div>
            
            <div class="viz-container">
                <div class="view-mode-selector">
                    <button class="view-btn active" data-view="cells">Cell Types</button>
                    <button class="view-btn" data-view="chemicals">Chemicals</button>
                    <button class="view-btn" data-view="genes">Gene Activity</button>
                </div>
                
                <div class="canvas-wrapper">
                    <canvas id="lifeCanvas"></canvas>
                </div>
                
                <div class="stats-bar">
                    <div class="stat-card">
                        <div class="stat-value" id="cellCount">1</div>
                        <div class="stat-label">Total Cells</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stemCells">1</div>
                        <div class="stat-label">Stem Cells</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="divisions">0</div>
                        <div class="stat-label">Cell Divisions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="generation">0</div>
                        <div class="stat-label">Generation</div>
                    </div>
                </div>
                
                <div class="cell-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #a855f7; color: #a855f7;"></div>
                        <span class="legend-label">Stem (Undifferentiated)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ef4444; color: #ef4444;"></div>
                        <span class="legend-label">Muscle (Movement)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #3b82f6; color: #3b82f6;"></div>
                        <span class="legend-label">Neural (Sensing)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #10b981; color: #10b981;"></div>
                        <span class="legend-label">Digestive (Energy)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f59e0b; color: #f59e0b;"></div>
                        <span class="legend-label">Structural (Support)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ec4899; color: #ec4899;"></div>
                        <span class="legend-label">Reproductive (Offspring)</span>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            LifeForge - Where information becomes form
            <br>Simulating the bridge between genotype and phenotype
        </footer>
    </div>

    <script>
        // ============================================
        // LIFEFORGE - DEVELOPMENTAL BIOLOGY SIMULATOR
        // ============================================
        
        const canvas = document.getElementById('lifeCanvas');
        const ctx = canvas.getContext('2d');
        
        // Configuration - define FIRST before anything else
        const Config = {
            cellSize: window.innerWidth < 640 ? 6 : 8,
            gridWidth: 0,
            gridHeight: 0,
            speed: 3,
            mutationRate: 0.02,
            morphogenStrength: 5,
            divisionRate: 5,
            developmentMode: 'symmetric'
        };
        
        // Set canvas size - define the function but DON'T call it yet
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            // Mobile-friendly height
            if (window.innerWidth < 768) {
                canvas.height = 400;
            } else {
                canvas.height = 600;
            }
            
            // Recalculate grid dimensions
            Config.gridWidth = Math.floor(canvas.width / Config.cellSize);
            Config.gridHeight = Math.floor(canvas.height / Config.cellSize);
            
            // Reinitialize morphogen field with new dimensions
            if (typeof morphogenField !== 'undefined') {
                morphogenField = new MorphogenField();
            }
            
            // Redraw if we have cells
            if (typeof cells !== 'undefined' && cells.length > 0) {
                draw();
            }
        }
        
        // Cell types with colors
        const CellTypes = {
            STEM: { name: 'stem', color: '#a855f7', glow: 'rgba(168, 85, 247, 0.5)' },
            MUSCLE: { name: 'muscle', color: '#ef4444', glow: 'rgba(239, 68, 68, 0.5)' },
            NEURAL: { name: 'neural', color: '#3b82f6', glow: 'rgba(59, 130, 246, 0.5)' },
            DIGESTIVE: { name: 'digestive', color: '#10b981', glow: 'rgba(16, 185, 129, 0.5)' },
            STRUCTURAL: { name: 'structural', color: '#f59e0b', glow: 'rgba(245, 158, 11, 0.5)' },
            REPRODUCTIVE: { name: 'reproductive', color: '#ec4899', glow: 'rgba(236, 72, 153, 0.5)' }
        };
        
        // Cell class
        class Cell {
            constructor(x, y, type = CellTypes.STEM, generation = 0) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.age = 0;
                this.generation = generation;
                this.energy = 100;
                this.divisionCooldown = 0;
                this.readyToDivide = false;
            }
            
            update(morphogenField) {
                this.age++;
                this.divisionCooldown = Math.max(0, this.divisionCooldown - 1);
                
                // Get chemical signals at position
                const signals = morphogenField.getSignalsAt(this.x, this.y);
                
                // Differentiation logic based on position and signals
                if (this.type === CellTypes.STEM && this.age > 10) {
                    this.differentiate(signals);
                }
                
                // Division readiness
                if (this.divisionCooldown === 0 && this.age > 5 && Math.random() < Config.divisionRate / 100) {
                    this.readyToDivide = true;
                }
            }
            
            differentiate(signals) {
                const posX = this.x / Config.gridWidth;
                const posY = this.y / Config.gridHeight;
                
                // Differentiation based on position and development mode
                if (Config.developmentMode === 'symmetric') {
                    // Bilateral symmetry
                    if (posY < 0.2) {
                        this.type = CellTypes.NEURAL; // Head
                    } else if (posY > 0.8) {
                        this.type = CellTypes.REPRODUCTIVE; // Tail
                    } else if (posX < 0.3 || posX > 0.7) {
                        this.type = CellTypes.MUSCLE; // Sides
                    } else if (posY > 0.4 && posY < 0.6) {
                        this.type = CellTypes.DIGESTIVE; // Center
                    } else {
                        this.type = CellTypes.STRUCTURAL; // Structure
                    }
                } else if (Config.developmentMode === 'segmented') {
                    // Segmented body
                    const segment = Math.floor(posY * 5);
                    if (segment === 0) this.type = CellTypes.NEURAL;
                    else if (segment % 2 === 0) this.type = CellTypes.MUSCLE;
                    else this.type = CellTypes.STRUCTURAL;
                } else if (Config.developmentMode === 'radial') {
                    // Radial symmetry
                    const centerX = 0.5;
                    const centerY = 0.5;
                    const dist = Math.sqrt((posX - centerX)**2 + (posY - centerY)**2);
                    
                    if (dist < 0.2) this.type = CellTypes.DIGESTIVE; // Center
                    else if (dist < 0.4) this.type = CellTypes.STRUCTURAL;
                    else this.type = CellTypes.NEURAL; // Edges
                } else {
                    // Random
                    const types = [CellTypes.MUSCLE, CellTypes.NEURAL, CellTypes.DIGESTIVE, CellTypes.STRUCTURAL, CellTypes.REPRODUCTIVE];
                    this.type = types[Math.floor(Math.random() * types.length)];
                }
                
                // Mutation chance
                if (Math.random() < Config.mutationRate) {
                    const types = [CellTypes.MUSCLE, CellTypes.NEURAL, CellTypes.DIGESTIVE, CellTypes.STRUCTURAL, CellTypes.REPRODUCTIVE];
                    this.type = types[Math.floor(Math.random() * types.length)];
                }
            }
        }
        
        // Morphogen field for chemical signaling
        class MorphogenField {
            constructor() {
                this.anteriorPosterior = []; // Head to tail gradient
                this.dorsalVentral = []; // Back to belly gradient
                this.leftRight = []; // Symmetry gradient
                
                this.initialize();
            }
            
            initialize() {
                for (let y = 0; y < Config.gridHeight; y++) {
                    for (let x = 0; x < Config.gridWidth; x++) {
                        const normX = x / Config.gridWidth;
                        const normY = y / Config.gridHeight;
                        
                        this.anteriorPosterior.push(normY);
                        this.dorsalVentral.push(Math.abs(normX - 0.5) * 2);
                        this.leftRight.push(normX < 0.5 ? 0 : 1);
                    }
                }
            }
            
            getSignalsAt(x, y) {
                const index = y * Config.gridWidth + x;
                return {
                    ap: this.anteriorPosterior[index] || 0,
                    dv: this.dorsalVentral[index] || 0,
                    lr: this.leftRight[index] || 0
                };
            }
        }
        
        // Main simulation state
        let cells = [];
        let morphogenField = new MorphogenField();
        let running = false;
        let time = 0;
        let totalDivisions = 0;
        let viewMode = 'cells';
        
        // Initialize with single cell
        function initialize() {
            cells = [new Cell(
                Math.floor(Config.gridWidth / 2),
                Math.floor(Config.gridHeight / 2),
                CellTypes.STEM,
                0
            )];
            totalDivisions = 0;
            time = 0;
            updateStats();
            updatePhase();
        }
        
        // Update simulation
        function update() {
            if (!running) return;
            
            time++;
            
            // Update all cells
            cells.forEach(cell => cell.update(morphogenField));
            
            // Cell division
            const newCells = [];
            cells.forEach(cell => {
                if (cell.readyToDivide && cells.length < 2000) {
                    // Find empty neighbor
                    const directions = [
                        {dx: 1, dy: 0}, {dx: -1, dy: 0},
                        {dx: 0, dy: 1}, {dx: 0, dy: -1}
                    ];
                    
                    for (const dir of directions) {
                        const nx = cell.x + dir.dx;
                        const ny = cell.y + dir.dy;
                        
                        if (nx >= 0 && nx < Config.gridWidth && ny >= 0 && ny < Config.gridHeight) {
                            const occupied = cells.some(c => c.x === nx && c.y === ny);
                            if (!occupied) {
                                newCells.push(new Cell(nx, ny, CellTypes.STEM, cell.generation + 1));
                                cell.divisionCooldown = 30;
                                cell.readyToDivide = false;
                                totalDivisions++;
                                break;
                            }
                        }
                    }
                }
            });
            
            cells.push(...newCells);
            
            // Update display
            draw();
            updateStats();
            updatePhase();
            
            requestAnimationFrame(update);
        }
        
        // Draw cells
        function draw() {
            // Clear canvas
            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (viewMode === 'cells') {
                drawCells();
            } else if (viewMode === 'chemicals') {
                drawChemicals();
            } else if (viewMode === 'genes') {
                drawGeneActivity();
            }
        }
        
        function drawCells() {
            cells.forEach(cell => {
                const x = cell.x * Config.cellSize;
                const y = cell.y * Config.cellSize;
                
                // Cell body
                ctx.fillStyle = cell.type.color;
                ctx.beginPath();
                ctx.arc(x + Config.cellSize/2, y + Config.cellSize/2, Config.cellSize/2 - 1, 0, Math.PI * 2);
                ctx.fill();
                
                // Glow effect
                if (cell.age < 10) {
                    ctx.shadowColor = cell.type.glow;
                    ctx.shadowBlur = 10;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
            });
        }
        
        function drawChemicals() {
            // Draw morphogen gradient
            for (let y = 0; y < Config.gridHeight; y++) {
                for (let x = 0; x < Config.gridWidth; x++) {
                    const signals = morphogenField.getSignalsAt(x, y);
                    const intensity = signals.ap * 255;
                    
                    ctx.fillStyle = `rgba(79, 172, 254, ${intensity / 255 * 0.5})`;
                    ctx.fillRect(x * Config.cellSize, y * Config.cellSize, Config.cellSize, Config.cellSize);
                }
            }
            
            // Draw cells on top
            cells.forEach(cell => {
                const x = cell.x * Config.cellSize;
                const y = cell.y * Config.cellSize;
                
                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.beginPath();
                ctx.arc(x + Config.cellSize/2, y + Config.cellSize/2, Config.cellSize/3, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        function drawGeneActivity() {
            cells.forEach(cell => {
                const x = cell.x * Config.cellSize;
                const y = cell.y * Config.cellSize;
                
                // Color by gene expression (age-based as proxy)
                const activity = Math.min(cell.age / 50, 1);
                const r = Math.floor(activity * 255);
                const g = Math.floor((1 - activity) * 255);
                
                ctx.fillStyle = `rgb(${r}, ${g}, 100)`;
                ctx.fillRect(x, y, Config.cellSize, Config.cellSize);
                
                // Highlight dividing cells
                if (cell.readyToDivide) {
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, Config.cellSize, Config.cellSize);
                }
            });
        }
        
        // Update statistics
        function updateStats() {
            const stemCount = cells.filter(c => c.type === CellTypes.STEM).length;
            const maxGen = cells.length > 0 ? Math.max(...cells.map(c => c.generation)) : 0;
            
            document.getElementById('cellCount').textContent = cells.length;
            document.getElementById('stemCells').textContent = stemCount;
            document.getElementById('divisions').textContent = totalDivisions;
            document.getElementById('generation').textContent = maxGen;
        }
        
        // Update phase indicator
        function updatePhase() {
            let phase = '';
            if (cells.length === 1) {
                phase = 'SINGLE CELL';
            } else if (cells.length < 10) {
                phase = 'EARLY DIVISION';
            } else if (cells.length < 50) {
                phase = 'DIFFERENTIATION';
            } else if (cells.length < 200) {
                phase = 'MORPHOGENESIS';
            } else {
                phase = 'MATURE ORGANISM';
            }
            
            document.getElementById('phaseIndicator').textContent = `Development: ${phase}`;
        }
        
        // Control event listeners
        document.getElementById('startBtn').addEventListener('click', () => {
            if (!running) {
                running = true;
                update();
            }
        });
        
        document.getElementById('pauseBtn').addEventListener('click', () => {
            running = false;
        });
        
        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            initialize();
            draw();
        });
        
        document.getElementById('speedSlider').addEventListener('input', function() {
            Config.speed = parseInt(this.value);
            document.getElementById('speedValue').textContent = this.value + 'x';
        });
        
        document.getElementById('mutationSlider').addEventListener('input', function() {
            Config.mutationRate = parseInt(this.value) / 100;
            document.getElementById('mutationValue').textContent = this.value + '%';
        });
        
        document.getElementById('morphogenSlider').addEventListener('input', function() {
            Config.morphogenStrength = parseInt(this.value);
            document.getElementById('morphogenValue').textContent = this.value;
        });
        
        document.getElementById('divisionSlider').addEventListener('input', function() {
            Config.divisionRate = parseInt(this.value);
            document.getElementById('divisionValue').textContent = this.value;
        });
        
        // Experiment buttons
        document.getElementById('symmetricBtn').addEventListener('click', () => {
            Config.developmentMode = 'symmetric';
            initialize();
            draw();
        });
        
        document.getElementById('segmentedBtn').addEventListener('click', () => {
            Config.developmentMode = 'segmented';
            initialize();
            draw();
        });
        
        document.getElementById('radialBtn').addEventListener('click', () => {
            Config.developmentMode = 'radial';
            initialize();
            draw();
        });
        
        document.getElementById('randomBtn').addEventListener('click', () => {
            Config.developmentMode = 'random';
            initialize();
            draw();
        });
        
        // Intervention buttons
        document.getElementById('mutateBtn').addEventListener('click', () => {
            cells.forEach(cell => {
                if (Math.random() < 0.3) {
                    const types = [CellTypes.MUSCLE, CellTypes.NEURAL, CellTypes.DIGESTIVE, CellTypes.STRUCTURAL, CellTypes.REPRODUCTIVE];
                    cell.type = types[Math.floor(Math.random() * types.length)];
                }
            });
            draw();
        });
        
        document.getElementById('addCellsBtn').addEventListener('click', () => {
            for (let i = 0; i < 10; i++) {
                const x = Math.floor(Math.random() * Config.gridWidth);
                const y = Math.floor(Math.random() * Config.gridHeight);
                const occupied = cells.some(c => c.x === x && c.y === y);
                if (!occupied) {
                    cells.push(new Cell(x, y, CellTypes.STEM, 0));
                }
            }
            updateStats();
            draw();
        });
        
        document.getElementById('killCellsBtn').addEventListener('click', () => {
            const toRemove = Math.floor(cells.length * 0.2);
            for (let i = 0; i < toRemove; i++) {
                const index = Math.floor(Math.random() * cells.length);
                cells.splice(index, 1);
            }
            updateStats();
            draw();
        });
        
        // View mode buttons
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                viewMode = this.dataset.view;
                draw();
            });
        });
        
        // Export functions
        document.getElementById('exportImageBtn').addEventListener('click', () => {
            // Create a temporary canvas with white background
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = canvas.width;
            exportCanvas.height = canvas.height;
            const exportCtx = exportCanvas.getContext('2d');
            
            // Fill with dark background
            exportCtx.fillStyle = '#0a0e1a';
            exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
            
            // Draw current canvas content
            exportCtx.drawImage(canvas, 0, 0);
            
            // Add title and info
            exportCtx.fillStyle = '#4facfe';
            exportCtx.font = 'bold 20px Arial';
            exportCtx.fillText('LifeForge - Developmental Biology', 10, 30);
            
            exportCtx.fillStyle = '#a0c8ff';
            exportCtx.font = '14px Arial';
            exportCtx.fillText(`Cells: ${cells.length} | Phase: ${document.getElementById('phaseIndicator').textContent}`, 10, 55);
            exportCtx.fillText(`Mode: ${Config.developmentMode} | Time: ${time}`, 10, 75);
            
            // Convert to download
            exportCanvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lifeforge-${Date.now()}.png`;
                a.click();
                URL.revokeObjectURL(url);
            });
        });
        
        document.getElementById('exportDataBtn').addEventListener('click', () => {
            // Create comprehensive cell data export
            const exportData = {
                metadata: {
                    timestamp: new Date().toISOString(),
                    developmentTime: time,
                    phase: document.getElementById('phaseIndicator').textContent,
                    developmentMode: Config.developmentMode,
                    config: {
                        cellSize: Config.cellSize,
                        mutationRate: Config.mutationRate,
                        morphogenStrength: Config.morphogenStrength,
                        divisionRate: Config.divisionRate
                    }
                },
                statistics: {
                    totalCells: cells.length,
                    stemCells: cells.filter(c => c.type === CellTypes.STEM).length,
                    muscleCells: cells.filter(c => c.type === CellTypes.MUSCLE).length,
                    neuralCells: cells.filter(c => c.type === CellTypes.NEURAL).length,
                    digestiveCells: cells.filter(c => c.type === CellTypes.DIGESTIVE).length,
                    structuralCells: cells.filter(c => c.type === CellTypes.STRUCTURAL).length,
                    reproductiveCells: cells.filter(c => c.type === CellTypes.REPRODUCTIVE).length,
                    totalDivisions: totalDivisions,
                    maxGeneration: cells.length > 0 ? Math.max(...cells.map(c => c.generation)) : 0
                },
                cells: cells.map(cell => ({
                    x: cell.x,
                    y: cell.y,
                    type: cell.type.name,
                    age: cell.age,
                    generation: cell.generation,
                    energy: cell.energy
                }))
            };
            
            // Convert to JSON and download
            const jsonStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lifeforge-data-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });
        
        document.getElementById('exportStatsBtn').addEventListener('click', () => {
            // Create human-readable statistics report
            const stemCount = cells.filter(c => c.type === CellTypes.STEM).length;
            const muscleCount = cells.filter(c => c.type === CellTypes.MUSCLE).length;
            const neuralCount = cells.filter(c => c.type === CellTypes.NEURAL).length;
            const digestiveCount = cells.filter(c => c.type === CellTypes.DIGESTIVE).length;
            const structuralCount = cells.filter(c => c.type === CellTypes.STRUCTURAL).length;
            const reproductiveCount = cells.filter(c => c.type === CellTypes.REPRODUCTIVE).length;
            const maxGen = cells.length > 0 ? Math.max(...cells.map(c => c.generation)) : 0;
            
            const report = `
╔════════════════════════════════════════════════════════════════╗
║              LIFEFORGE DEVELOPMENT REPORT                      ║
╚════════════════════════════════════════════════════════════════╝

Generated: ${new Date().toLocaleString()}
Development Mode: ${Config.developmentMode}
Development Phase: ${document.getElementById('phaseIndicator').textContent}

═══════════════════════════════════════════════════════════════
ORGANISM STATISTICS
═══════════════════════════════════════════════════════════════

Total Cells:              ${cells.length}
Cell Divisions:           ${totalDivisions}
Maximum Generation:       ${maxGen}
Development Time:         ${time} cycles

═══════════════════════════════════════════════════════════════
CELL TYPE DISTRIBUTION
═══════════════════════════════════════════════════════════════

🟣 Stem Cells:            ${stemCount} (${(stemCount/cells.length*100).toFixed(1)}%)
🔴 Muscle Cells:          ${muscleCount} (${(muscleCount/cells.length*100).toFixed(1)}%)
🔵 Neural Cells:          ${neuralCount} (${(neuralCount/cells.length*100).toFixed(1)}%)
🟢 Digestive Cells:       ${digestiveCount} (${(digestiveCount/cells.length*100).toFixed(1)}%)
🟡 Structural Cells:      ${structuralCount} (${(structuralCount/cells.length*100).toFixed(1)}%)
🩷 Reproductive Cells:    ${reproductiveCount} (${(reproductiveCount/cells.length*100).toFixed(1)}%)

═══════════════════════════════════════════════════════════════
DEVELOPMENT PARAMETERS
═══════════════════════════════════════════════════════════════

Cell Size:                ${Config.cellSize}px
Mutation Rate:            ${(Config.mutationRate * 100).toFixed(1)}%
Morphogen Strength:       ${Config.morphogenStrength}
Division Rate:            ${Config.divisionRate}
Simulation Speed:         ${Config.speed}x

═══════════════════════════════════════════════════════════════
ANALYSIS
═══════════════════════════════════════════════════════════════

Differentiation Progress: ${((1 - stemCount/cells.length) * 100).toFixed(1)}%
Most Common Cell Type:    ${
    [
        {name: 'Stem', count: stemCount},
        {name: 'Muscle', count: muscleCount},
        {name: 'Neural', count: neuralCount},
        {name: 'Digestive', count: digestiveCount},
        {name: 'Structural', count: structuralCount},
        {name: 'Reproductive', count: reproductiveCount}
    ].sort((a, b) => b.count - a.count)[0].name
}
Development Stage:        ${
    cells.length === 1 ? 'Single Cell' :
    cells.length < 10 ? 'Early Division' :
    cells.length < 50 ? 'Differentiation' :
    cells.length < 200 ? 'Morphogenesis' :
    'Mature Organism'
}

═══════════════════════════════════════════════════════════════

Generated by LifeForge - Developmental Biology Simulator
Where information becomes form
═══════════════════════════════════════════════════════════════
`;
            
            // Download as text file
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lifeforge-report-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        });
        
        // Initialize on load - CALL EVERYTHING AT THE END
        window.addEventListener('load', () => {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            initialize();
            draw();
        });
    </script>
</body>
</html>